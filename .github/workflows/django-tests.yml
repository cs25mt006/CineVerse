name: Django CI

on:
push:
pull_request:

jobs:
test:
runs-on: ubuntu-latest

```
services:
  mysql:
    image: mysql:5.7
    env:
      MYSQL_ROOT_PASSWORD: harshini123
      MYSQL_DATABASE: CineVerse
      MYSQL_USER: root
      MYSQL_PASSWORD: harshini123
    ports:
      - 3306:3306
    options: >-
      --health-cmd="mysqladmin ping --silent"
      --health-interval=10s
      --health-timeout=5s
      --health-retries=10

steps:
  - name: Checkout repository
    uses: actions/checkout@v3

  - name: Set up Python 3.10
    uses: actions/setup-python@v3
    with:
      python-version: '3.10'

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r backend/requirements.txt
      pip install coverage

  - name: Wait for MySQL to initialize
    run: |
      sudo apt-get update
      sudo apt-get install -y mysql-client
      until mysqladmin ping -h127.0.0.1 -uroot -pharshini123 --silent; do
        echo "Waiting for MySQL to be ready..."
        sleep 2
      done

  - name: Set up Django environment
    run: |
      echo "DATABASES = {
          'default': {
              'ENGINE': 'django.db.backends.mysql',
              'NAME': 'CineVerse',
              'USER': 'root',
              'PASSWORD': 'harshini123',
              'HOST': '127.0.0.1',
              'PORT': '3306',
          }
      }" > backend/backend/settings_ci.py
    shell: bash

  - name: Apply database migrations
    run: python manage.py migrate --settings=backend.settings_ci
    working-directory: backend

  - name: Run Django tests with coverage
    run: |
      coverage run manage.py test --settings=backend.settings_ci
      coverage report --fail-under=60
    working-directory: backend

  - name: Generate HTML coverage report
    run: coverage html --directory=htmlcov
    working-directory: backend

  - name: Upload coverage report artifact
    uses: actions/upload-artifact@v4
    with:
      name: htmlcov
      path: backend/htmlcov/